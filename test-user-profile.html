<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile Test - MYCOgenesis</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-2xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">User Profile Test</h1>
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-md">
                    <h2 class="font-semibold text-blue-900 mb-2">Instructions:</h2>
                    <ol class="list-decimal list-inside text-blue-800 space-y-1">
                        <li>Open browser developer console (F12)</li>
                        <li>Log in to your account first</li>
                        <li>Run: <code class="bg-blue-100 px-1 rounded">checkUserProfile()</code></li>
                        <li>If no profile exists, run: <code class="bg-blue-100 px-1 rounded">migrateUserProfile()</code></li>
                    </ol>
                </div>
                
                <div id="auth-status" class="p-4 bg-gray-50 border border-gray-200 rounded-md">
                    <h3 class="font-semibold text-gray-900 mb-2">Authentication Status:</h3>
                    <p id="auth-info" class="text-gray-600">Checking...</p>
                </div>
                
                <div id="profile-status" class="p-4 bg-gray-50 border border-gray-200 rounded-md">
                    <h3 class="font-semibold text-gray-900 mb-2">Profile Status:</h3>
                    <p id="profile-info" class="text-gray-600">Checking...</p>
                </div>
                
                <div class="flex space-x-4">
                    <button id="check-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        Check Profile
                    </button>
                    <button id="migrate-profile-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                        Create Profile
                    </button>
                    <a href="auth/login.html" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md inline-block">
                        Login
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="js/config/firebase-config.js"></script>
    
    <!-- Migration Utility -->
    <script type="module">
        import { migrateUserProfile, checkUserProfile } from './js/utils/user-profile-migration.js';
        
        // Make functions available globally
        window.migrateUserProfile = migrateUserProfile;
        window.checkUserProfile = checkUserProfile;
        
        // DOM elements
        const authInfo = document.getElementById('auth-info');
        const profileInfo = document.getElementById('profile-info');
        const checkBtn = document.getElementById('check-profile-btn');
        const migrateBtn = document.getElementById('migrate-profile-btn');
        
        // Check auth state
        function updateAuthStatus() {
            const auth = window.firebaseServices.auth;
            const user = auth.currentUser;
            
            if (user) {
                authInfo.innerHTML = `
                    <span class="text-green-600">✅ Logged in as: ${user.email}</span><br>
                    <span class="text-sm text-gray-500">UID: ${user.uid}</span>
                `;
            } else {
                authInfo.innerHTML = '<span class="text-red-600">❌ Not logged in</span>';
            }
        }
        
        // Check profile status
        async function updateProfileStatus() {
            try {
                const hasProfile = await checkUserProfile();
                if (hasProfile) {
                    profileInfo.innerHTML = '<span class="text-green-600">✅ Profile exists in Firestore</span>';
                } else {
                    profileInfo.innerHTML = '<span class="text-red-600">❌ No profile found in Firestore</span>';
                }
            } catch (error) {
                profileInfo.innerHTML = '<span class="text-red-600">❌ Error checking profile</span>';
            }
        }
        
        // Button handlers
        checkBtn.addEventListener('click', async () => {
            checkBtn.disabled = true;
            checkBtn.textContent = 'Checking...';
            
            await updateProfileStatus();
            
            checkBtn.disabled = false;
            checkBtn.textContent = 'Check Profile';
        });
        
        migrateBtn.addEventListener('click', async () => {
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'Creating...';
            
            try {
                const success = await migrateUserProfile();
                if (success) {
                    await updateProfileStatus();
                }
            } catch (error) {
                console.error('Migration failed:', error);
            }
            
            migrateBtn.disabled = false;
            migrateBtn.textContent = 'Create Profile';
        });
        
        // Wait for Firebase to initialize
        setTimeout(() => {
            updateAuthStatus();
            updateProfileStatus();
            
            // Listen for auth state changes
            window.firebaseServices.auth.onAuthStateChanged(() => {
                updateAuthStatus();
                updateProfileStatus();
            });
        }, 1000);
    </script>
</body>
</html>